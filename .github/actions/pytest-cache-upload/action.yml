name: Upload PyTest cache

description: Uploads the pytest cache to S3

inputs:
  cache_dir:
    description: Path to the pytest cache directory, relative to $GITHUB_WORKSPACE. This folder will be zipped and uploaded to S3.
    required: true
  shard:
    description: Shard number for the current job
    required: false
    default: "0"
  github-token:
    description: GITHUB_TOKEN
    required: true
  aws-access-key-id:
    description: AWS access key id
    required: true
  aws-secret-access-key:
    description: AWS secret access key
    required: true

runs:
  using: composite
  steps:
    - uses: nick-fields/retry@3e91a01664abd3c5cd539100d10d33b9c5b68482
      name: Setup dependencies
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      with:
        shell: bash
        timeout_minutes: 5
        max_attempts: 5
        retry_wait_seconds: 30
        command: |
          set -eux
          python3 -m pip install boto3==1.19.12

    - name: Upload the cache
      shell: bash
      env:
        CACHE_DIR: ${{ inputs.cache_dir }}
        WORKFLOW: ${{ github.workflow }}
        JOB: ${{ github.job }}
        SHARD: ${{ inputs.shard }}
        AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key-id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws-secret-access-key }}
      run: |
        set -x

        echo "all the commands sent to the below script:"
        echo "cache_dir: $GITHUB_WORKSPACE/$CACHE_DIR"
        echo "pr_identifier: $GITHUB_REF"
        echo "workflow: $WORKFLOW"
        echo "job: $JOB"
        echo "shard: $SHARD"
        echo "temp_dir: $RUNNER_TEMP"

        python3 .github/scripts/pytest_cache.py \
          --upload \
          --cache_dir $GITHUB_WORKSPACE/$CACHE_DIR \
          --pr_identifier $GITHUB_REF \
          --workflow $WORKFLOW \
          --job $JOB \
          --shard $SHARD \
          --temp_dir $RUNNER_TEMP \